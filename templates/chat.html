<!DOCTYPE html>
<html>
<head>
	<title>chat</title>
	<script src="{{ url_for('static', filename='js/jquery.min.js') }}" type="text/javascript"></script>
	<link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />
	<link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/style.css') }}" />
	<script src="{{ url_for('static', filename='js/titlealert.js') }}" type="text/javascript"></script>
</head>
<body>
	<p><b>hi, {{ user }}</b></p>
	<small class="pull-right"><span class="label label-success">Users Online:</span>
		{% for online in online %}
			{{online}} /
		{% endfor %}
	</small>
	<p>Message: <input class="form-control" id="in" /></p>
	<div id="out"></div>
	<div class="old">
	{% for msg in msgs %}
		<p class="chatmsg"><strong>{{msg.usr}}:</strong> {{ msg.msg }}</p>
	{% endfor %}
	</div>
	<script>
		function sse() {
			var source = new EventSource('/stream');
			var out = document.getElementById('out');
			source.onmessage = function(e) {
				// XSS in chat is fun
				out.innerHTML =  e.data + '' + out.innerHTML;

				var titl = e.data.replace(/<\/?[^>]+(>|$)/g, "");
				document.title = titl;
				parent.document.title = titl;

				$("title","head").text(titl).trigger("change");
				window.parent.$("title","head").text(titl).trigger("change");
				
				$.titleAlert(titl, {
				    requireBlur:true,
				    stopOnFocus:true,
				    interval:600
				});

			};
		}
		$('#in').keyup(function(e){
			if (e.keyCode == 13) {
				$.post('/post', {'message': $(this).val()});
				$(this).val('');
			}
		});
		sse();
	</script>
</body>
</html>